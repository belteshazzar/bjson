<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RTree Compaction (Browser)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; line-height: 1.5; }
    button { padding: 8px 14px; font-size: 14px; cursor: pointer; }
    pre { background: #f4f4f4; padding: 12px; border-radius: 6px; overflow: auto; }
    .log { margin-top: 16px; }
  </style>
</head>
<body>
  <h1>RTree Compaction (Browser)</h1>
  <p>This demo uses OPFS in the browser to create an R-tree with geographic points, compact it, and show search results before and after.</p>
  <p><strong>Requirement:</strong> Chrome 102+ (OPFS available). If unsupported, an error will be shown.</p>
  <button id="run">Run Demo</button>
  <div class="log">
    <pre id="output"></pre>
  </div>

  <script type="module">
    import { RTree } from '/src/rtree.js';
    import { ObjectId } from '/src/bjson.js';

    const output = document.getElementById('output');
    const runBtn = document.getElementById('run');

    // Initialize web worker for sync file operations
    const worker = new Worker('/dist/worker.js');
    let workerMessageId = 0;
    const workerPromises = new Map();
    
    worker.addEventListener('message', (event) => {
      const { id, result, error } = event.data;
      const promise = workerPromises.get(id);
      
      if (promise) {
        if (error) {
          promise.reject(new Error(error));
        } else {
          promise.resolve(result);
        }
        workerPromises.delete(id);
      }
    });
    
    function callWorker(operation, filename, data) {
      return new Promise((resolve, reject) => {
        const id = ++workerMessageId;
        workerPromises.set(id, { resolve, reject });
        
        worker.postMessage({ id, operation, filename, data });
      });
    }

    function log(line) {
      output.textContent += `${line}\n`;
    }

    async function cleanup(file) {
      const root = await navigator.storage.getDirectory();
      try {
        await root.removeEntry(file);
      } catch (err) {
        // Ignore if missing
      }
    }

    async function runDemo() {
      output.textContent = '';

      if (!navigator.storage || !navigator.storage.getDirectory) {
        log('OPFS not supported in this browser.');
        return;
      }

      const filename = 'browser-rtree.bjson';
      const compacted = 'browser-rtree-compacted.bjson';

      await cleanup(filename);
      await cleanup(compacted);

      try {
        log('Creating R-tree...');
        await callWorker('rtree-create', filename, { order: 4 });
        
        log('Inserting points...');
        const points = [
          { id: 'sf', lat: 37.7749, lng: -122.4194 },
          { id: 'la', lat: 34.0522, lng: -118.2437 },
          { id: 'nyc', lat: 40.7128, lng: -74.0060 },
          { id: 'chi', lat: 41.8781, lng: -87.6298 }
        ];

        for (const point of points) {
          // Create ObjectId for each point
          const oid = new ObjectId();
          await callWorker('rtree-insert', filename, { 
            lat: point.lat, 
            lng: point.lng, 
            objectId: oid.toString() 
          });
        }

        log('\n=== Before Compaction ===');
        const radiusResults = await callWorker('rtree-searchRadius', filename, { 
          lat: 37.7749, 
          lng: -122.4194, 
          radiusKm: 500 
        });
        log(`Within 500km of SF: ${JSON.stringify(radiusResults)}`);

        const bboxResults = await callWorker('rtree-searchBBox', filename, {
          bbox: {
            minLat: 30,
            maxLat: 42,
            minLng: -125,
            maxLng: -70
          }
        });
        log(`BBox covering US entries: ${JSON.stringify(bboxResults)}`);

        log('\n=== Compacting ===');
        const stats = await callWorker('rtree-compact', filename, { compactFilename: compacted });
        log('Compaction stats:');
        log(JSON.stringify(stats, null, 2));

        log('\n=== After Compaction ===');
        const postCompactResults = await callWorker('rtree-searchRadius', compacted, { 
          lat: 39, 
          lng: -98, 
          radiusKm: 2500 
        });
        log(`Within 2500km of US center: ${JSON.stringify(postCompactResults, null, 2)}`);
      } catch (err) {
        log(`Error: ${err.message || err}`);
        console.error(err);
      }
    }

    runBtn.addEventListener('click', () => runDemo().catch((err) => {
      log(`Error: ${err.message || err}`);
      console.error(err);
    }));
  </script>
</body>
</html>
